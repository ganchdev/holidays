<% content_for :title, t("titles.bookings") %>
<%= render_nav title: t("titles.bookings"), back_url: property_path(@property) do %>
  <li>
    <%= link_to t("buttons.today"), property_bookings_path, type: "button" %>
  </li>
<% end %>

<div data-controller="horizontal-calendar">
  <div data-horizontal-calendar-target="monthHeader"></div>
  <div data-horizontal-calendar-target="scrollContainer" class="horizontal-calendar-container">
    <!-- Fixed left column for room numbers -->
    <div class="fixed-room-column">
      <div class="room-header-placeholder"></div>
      <% @rooms.each do |room| %>
        <div class="room-label-fixed" style="background-color: <%= room.color %>">
          <%= room.name %>
        </div>
      <% end %>
    </div>

    <!-- Scrollable calendar area -->
    <div class="scrollable-calendar">
      <!-- Day headers -->
      <div class="calendar-headers">
        <% @days.each do |day_data| %>
          <% date, bookings = day_data %>
          <div class="day-header" data-date="<%= date.to_s %>" data-horizontal-calendar-target="day">
            <%= link_to day_property_bookings_path(@property, day: date), class: "date-link", data: { turbo_prefetch: false } do %>
              <span class="date-number"><%= I18n.l(date, format: "%d") %></span>
              <span class="date-day"><%= I18n.t('date.abbr_day_names')[date.wday] %></span>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Room rows with booking spans -->
      <div class="calendar-body">
        <% @rooms.each do |room| %>
          <div class="room-row" data-room-id="<%= room.id %>">
            <div class="room-timeline">
              <% @days.each do |day_data| %>
                <% date, bookings = day_data %>
                <% room_booking = bookings.find { |b| b.room_id == room.id } %>
                <div class="day-cell" data-date="<%= date.to_s %>" data-room-id="<%= room.id %>">
                  <% if room_booking %>
                    <%# This will be filled by booking spans via CSS positioning %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Booking spans (positioned absolutely) -->
      <div class="booking-spans-container">
        <%
          # Extract all unique bookings from @days to avoid duplicate queries
          all_bookings = @days.flat_map { |date, bookings| bookings }.uniq

          # Create a date to index mapping for fast lookups
          date_to_index = @days.each_with_index.to_h { |(date, _), index| [date, index] }
        %>

        <% all_bookings.each do |booking| %>
          <%
            start_date = booking.starts_at.to_date
            end_date = booking.ends_at.to_date - 1.day
            checkout_date = booking.ends_at.to_date

            # Use the pre-built index mapping instead of expensive @days.index calls
            start_index = date_to_index[start_date]
            end_index = date_to_index[end_date]
            checkout_index = date_to_index[checkout_date]
          %>

          <% if start_index %>
            <%
              # For each day the booking spans, determine if it's partial
              booking_parts = []

              # Check if this is a one-night booking (check-in and checkout are consecutive days)
              is_one_night_booking = checkout_index && start_index && checkout_index == start_index + 1

              # Add regular booking days (full occupancy)
              if end_index
                (start_index..end_index).each do |day_index|
                  current_date = @days[day_index][0]

                  # Check if this is check-in day (booking starts here)
                  is_checkin_day = current_date == booking.starts_at.to_date

                  if is_checkin_day && !is_one_night_booking
                    # Check-in day - right half only (afternoon arrival) for multi-night bookings
                    booking_parts << { index: day_index, offset: 0.5, width: 0.5 }
                  elsif is_checkin_day && is_one_night_booking
                    # One-night booking - show from check-in (right half) through checkout (left half) as continuous span
                    booking_parts << { index: day_index, offset: 0.5, width: 1 }
                  else
                    # Full day
                    booking_parts << { index: day_index, offset: 0, width: 1 }
                  end
                end
              end

              # Add checkout day if it exists (left half only - morning departure) and NOT a one-night booking
              if checkout_index && checkout_index != start_index && !is_one_night_booking
                booking_parts << { index: checkout_index, offset: 0, width: 0.5 }
              end

              # Combine consecutive full days into single spans
              combined_spans = []
              current_span = nil

              booking_parts.each do |part|
                if part[:width] == 1 && current_span &&
                   part[:index] == current_span[:end_index] + 1 &&
                   part[:offset] == 0
                  # Extend current span
                  current_span[:end_index] = part[:index]
                  current_span[:width] = current_span[:end_index] - current_span[:start_index] + 1
                else
                  # Start new span
                  combined_spans << current_span if current_span
                  current_span = {
                    start_index: part[:index],
                    end_index: part[:index],
                    offset: part[:offset],
                    width: part[:width]
                  }
                end
              end
              combined_spans << current_span if current_span
            %>

            <% combined_spans.each do |span| %>
              <%= link_to property_booking_path(@property, booking),
                  class: "booking-span #{'booking-span--half-day' if span[:width] == 0.5}",
                  style: "--start-index: #{span[:start_index]}; --left-offset: #{span[:offset]}; --span-width: #{span[:width]}; --width-adjustment: 0; background-color: #{booking.room.color}",
                  data: { booking_id: booking.id, room_id: booking.room_id } do %>
                <% unless span[:width] == 0.5 %>
                  <div class="booking-name"><%= booking.name || "Booking ##{booking.id}" %></div>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
